/*!
 * Figuration Table(v0.0.1)
 * https://github.com/cast-org/figuration-table
 * Copyright 2017 CAST, Inc.
 * Licensed under MIT (https://github.com/cast-org/figuration-table/blob/master/LICENSE)
 */
if("undefined"==typeof jQuery)throw new Error("Figuration Table's JavaScript requires jQuery");!function(a){var b=a.fn.jquery.split(" ")[0].split(".");if(b[0]<2&&b[1]<9||1==b[0]&&9==b[1]&&b[2]<1||b[0]>=4)throw new Error("Figuration Table's JavaScript requires at least jQuery v1.9.1 but less than v4.0.0")}(jQuery),function(a){"use strict";function b(a){a&&a()}function c(){var a=document.createElement("div"),b={transition:"transitionend",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",WebkitTransition:"webkitTransitionEnd"};for(var c in b)if(void 0!==a.style[c])return{end:b[c]};return{end:"cfwTransitionEnd"}}function d(a){var b=[0];a.each(function(){var c=a.css("transition-duration")||a.css("-webkit-transition-duration")||a.css("-moz-transition-duration")||a.css("-ms-transition-duration")||a.css("-o-transition-duration");if(c)for(var d=c.split(","),e=d.length;e--;)b=b.concat(parseFloat(d[e]))});var c=Math.max.apply(Math,b);return c*=1e3}function e(a,c){var e=d(this);if(e){var f=!1;this.one("cfwTransitionEnd",function(){f||(f=!0,b(c))}),setTimeout(function(){f||(f=!0,b(c))},e),b(a)}else b(a),b(c);return this}function f(){return{bindType:g.end,delegateType:g.end,handle:function(b){if(a(b.target).is(this))return b.handleObj.handler.apply(this,arguments)}}}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var g=!1;a(function(){g=c(),a.fn.CFW_transition=e,a.event.special.cfwTransitionEnd=f()}),a.fn.CFW_getID=function(b){var c=a(this),d=c.attr("id");if(void 0===d){do d=b+"-"+~~(1e6*Math.random());while(document.getElementById(d));c.attr("id",d)}return d},a.fn.CFW_trigger=function(b,c){var d=a.Event(b);return a.isPlainObject(c)&&(d=a.extend({},d,c)),a(this).trigger(d),!d.isDefaultPrevented()},a.fn.CFW_parseData=function(b,c){var d={},e=a(this),f=e.data();b=b.capitalize();for(var g in c)if(c.hasOwnProperty(g)){var h=g.capitalize();void 0!==f["cfw"+b+h]&&(d[g]=f["cfw"+b+h])}return d},a.fn.CFW_throttle=function(a,b,c){void 0===b&&(b=250);var d,e;return function(){var f=c||this,g=+new Date,h=arguments;d&&g<d+b?(clearTimeout(e),e=setTimeout(function(){d=g,a.apply(f,h)},b)):(d=g,a.apply(f,h))}}}(jQuery),function(a){"use strict";function b(b){var d=[].splice.call(arguments,1);return this.each(function(){var e=a(this),f=e.data("cfw.table"),g="object"==typeof b&&b;if(!f&&/dispose/.test(b))return!1;f||e.data("cfw.table",f=new c(this,g)),"string"==typeof b&&f[b].apply(f,d)})}var c=function(b,d){this.element=b,this.$element=a(b),this.$active=null,this.$editor=null,this.$sorter=null,this.instance=null,this.selectors=c.SELECTORS;var e=this.$element.CFW_parseData("table",c.DEFAULTS);this.settings=a.extend({},c.DEFAULTS,e,d),this._init()};c.DEFAULTS={sortable:!1,editable:!1,coledit:!1,json:null,editor:'<input type="text">',editorProps:["font","font-size","font-family","font-weight","line-height","padding","padding-top","padding-bottom","padding-left","padding-right","border","border-top","border-bottom","border-left","border-right"]},c.SELECTORS={headRow:"thead tr",headCols:"thead th",headCells:"th",headSort:"thead th .sort-icon",bodyElm:"tbody",bodyRows:"tbody tr",bodyCells:"tbody td",rowElm:"tr",rowCells:"td"},a.fn.CFW_Table_JSON=function(){for(var b=a(this),c=[],d=b.find("thead th"),e=d.length,f=0;f<e;f++)c[f]=a.trim(d.eq(f).text());var g=[],h=b.find("tbody tr"),i=h.length;for(f=0;f<i;f++){for(var j=[],k=h.eq(f).find("td"),l=0;l<e;l++)j[l]=a.trim(k.eq(l).text());g.push(j)}var m={header:c,rows:g};return JSON.stringify(m)},c.prototype={_init:function(){this.instance=this.$element.CFW_getID("cfw-table"),this.$element.addClass("figuration-table"),null!==this.settings.json&&this.jsonInput(this.settings.json),this.settings.editable&&this.editEnable(),this.settings.coledit&&this.colEditEnable(),this.settings.sortable&&this.sortEnable(),this.$element.CFW_trigger("init.cfw.table")},insertRow:function(b){var c=this;if(this.$element.CFW_trigger("beforeInsertRow.cfw.table")){null==b&&(b=-1);for(var d=this.$element.find(this.selectors.bodyRows),e=Math.max.apply(null,d.map(function(){return a(this).find(c.selectors.rowCells).length}).get()),f=this.$element.find(this.selectors.bodyElm)[0].insertRow(b),g=0;g<e;g++){var h=f.insertCell(g);this._updateCell(h)}this.$element.CFW_trigger("afterInsertRow.cfw.table")}},deleteRow:function(a){if(this.$element.CFW_trigger("beforeDeleteRow.cfw.table")){null==a&&(a=-1);this.$element.find(this.selectors.bodyRows).length>1&&this.element.deleteRow(a),this.$element.CFW_trigger("afterDeleteRow.cfw.table")}},appendCol:function(a){if(this.$element.CFW_trigger("beforeAppendCol.cfw.table")){null==a&&(a=-1);var b=this.$element.find(this.selectors.headRow)[0],c=document.createElement("th");if(a==-1)b.appendChild(c);else{var d=this.$element.find(this.selectors.headCols).get(a);b.insertBefore(c,d)}for(var e=this.$element.find(this.selectors.bodyRows),f=e.length,g=0;g<f;g++)this._updateCell(e[g].insertCell(a));this.settings.sortable&&this._sortUpdate(),this.$element.CFW_trigger("afterAppendCol.cfw.table")}},removeCol:function(a){if(this.$element.CFW_trigger("beforeRemoveCol.cfw.table")){null==a&&(a=-1);if(this.$element.find(this.selectors.headCols).length>1){this.$element.find(this.selectors.headRow)[0].deleteCell(a);for(var b=this.$element.find(this.selectors.bodyRows),c=b.length,d=0;d<c;d++)b[d].deleteCell(a)}this.settings.sortable&&this._sortUpdate(),this.$element.CFW_trigger("afterRemoveCol.cfw.table")}},_updateCells:function(){var b=this,c=this.$element.find(this.selectors.rowCells);a.each(c,function(){var c=a(this);b._updateCell(c)})},_resetCell:function(a){a.removeAttr("tabindex").removeClass("text-right")},_updateCell:function(b){var c=a(b),d=a.trim(c.text());c.text(d),this._resetCell(c),a.isNumeric(d)&&c.addClass("text-right"),this.settings.editable&&c.attr("tabindex",0)},_showEditor:function(){(this.settings.editable||this.settings.coledit)&&(this.$active=this.$element.find("td:focus, th:focus"),this.$active.length&&this._editorCreate(this.$active))},_actionKeydown:function(a){if(13==a.which)return a.stopPropagation(),a.preventDefault(),void this._showEditor();this._actionMove(a)},_actionMove:function(b){if(/(37|38|39|40)/.test(b.which)){b.stopPropagation(),b.preventDefault();var c=a(b.target),d=c.closest(this.selectors.rowElm),e=d.prev(),f=d.next(),g=this.selectors.rowCells;if(this.settings.sortable||this.settings.coledit){g+=","+this.selectors.headCells;for(var h=this.$element.find(this.selectors.rowElm),i=h.length,j=0;j<i;j++)if(h.eq(j).is(d)){e=j>0?h.eq(j-1):e,f=j<i?h.eq(j+1):f;break}this.settings.sortable&&c.hasClass("sort-icon")&&(c=c.closest(this.selectors.headCells))}var k=null;switch(b.which){case 37:k=c.prev(g).find("[tabindex=0]").addBack().filter("[tabindex=0]").first();break;case 38:k=e.children().eq(c.index()).find("[tabindex=0]").addBack().filter("[tabindex=0]").first();break;case 39:k=c.next(g).find("[tabindex=0]").addBack().filter("[tabindex=0]").first();break;case 40:k=f.children().eq(c.index()).find("[tabindex=0]").addBack().filter("[tabindex=0]").first()}k&&k.length>0&&k.focus()}},_editorCreate:function(b){var c=this;this.$element.CFW_trigger("beforeShowEditor.cfw.table")&&(this.$editor=a(this.settings.editor).val(b.text()).addClass("figuration-table-editor").css(b.css(this.settings.editorProps)).data("cfw.table",this).appendTo("body"),this._editorPosition(),this.$editor.trigger("focus"),a(window).on("resize.cfw.table"+this.instance,a.proxy(this._editorPosition,this)),this.$editor.on("blur.cfw.table",function(){c.editorSave()}).on("keydown.cfw.table",function(a){c.editorKeydown(a)}).on("input.cfw.table paste.cfw.table",function(){var b=a.Event("validate.cfw.table");b=a.extend({},b,{value:c.$editor.val()}),c.$active.trigger(b),b.result===!1?c.$editor.addClass("error"):c.$editor.removeClass("error")}),this.$element.CFW_trigger("afterShowEditor.cfw.table",{editor:this.$editor[0]}))},_editorPosition:function(){this.$editor.is(":visible")&&this.$editor.offset(this.$active.offset()).width(this.$active.width()).height(this.$active.height())},_editorRemove:function(){null!=this.$editor&&this.$element.CFW_trigger("beforeHideEditor.cfw.table",{editor:this.$editor[0]})&&(a(window).off("resize.cfw.table"+this.instance),this.$editor&&this.$editor.removeData("cfw.table").remove(),this.$editor=null,this.$active=null,this.$element.CFW_trigger("afterHideEditor.cfw.table"))},editorSave:function(){this._setActiveValue(),this._editorRemove()},editorCancel:function(){this.$editor.val(this.$active.text())},editorKeydown:function(a){if(/(37|38|39|40)/.test(a.which))return void a.stopPropagation();if(/(9|13|27)/.test(a.which)){if(9==a.which)return void this.$active.trigger("focus");13==a.which&&(a.stopPropagation(),a.preventDefault(),this.$active.trigger("focus")),27==a.which&&(a.stopPropagation(),a.preventDefault(),this.editorCancel(),this.$active.trigger("focus"))}},_setActiveValue:function(){if(null!=this.$editor){var b=this.$editor.val(),c=this.$active.html();if(this.$active.text()===b||this.$editor.hasClass("error"))return!0;var d=a.Event("change.cfw.table");d=a.extend({},d,{value:b}),this.$active.text(b).trigger(d),d.result===!1&&this.$active.html(c),this.$active.is(this.selectors.headCells)?this._sortUpdate():this._updateCell(this.$active)}},editEnable:function(){this.settings.editable=!0,this.$element.off("click.cfw.table",this.selectors.rowCells).on("click.cfw.table",this.selectors.rowCells,a.proxy(this._showEditor,this)).off("keydown.cfw.table",this.selectors.rowCells).on("keydown.cfw.table",this.selectors.rowCells,a.proxy(this._actionKeydown,this)).addClass("editable"),this._updateCells()},editDisable:function(){this.settings.editable=!1,this.$element.off("click.cfw.table",this.selectors.rowCells).off("keydown.cfw.table",this.selectors.rowCells).removeClass("editable"),this._updateCells()},_sortSimple:function(b,c){function d(b,c){return a(b).children("td").eq(c).html()}function e(b){return function(c,e){var f=d(c,b),g=d(e,b);return a.isNumeric(f)&&a.isNumeric(g)?f-g:f.localeCompare(g,"en",{numeric:!0})}}if(this.settings.sortable){void 0===c&&(c=!0),this.$sorter=this.$element.find(this.selectors.headCols).eq(b);var f=this.$element.find(this.selectors.bodyRows),g=this.$sorter.data("cfw.table.sortOrder");void 0!==typeof g&&(c=!g),this.$sorter.data("cfw.table.sortOrder",c);var h=f.toArray().sort(e(b)),i=h.length;c||(h=h.reverse());for(var j=0;j<i;j++)this.$element.find(this.selectors.bodyElm).append(h[j]);this._sortUpdate()}},_sortUpdate:function(){var b=this.$element.find(this.selectors.headCols),c=this.$sorter&&this.$sorter.data("cfw.table.sortOrder"),d=c?"ascending":"descending";if(b.removeAttr("aria-sort").removeData("cfw.table.sortOrder").find(".sort-icon").removeClass("sort-ascending sort-descending"),this.settings.sortable&&a.each(b,function(){var b=a(this);if(!b.find(".sort-icon").length){var c=a('<a href="#" role="button" class="sort-icon" tabindex=0 aria-label="Change column sort order">');b.append(c)}}),null!==this.$sorter){var e="sort-"+d;this.$sorter.attr("aria-sort",d).data("cfw.table.sortOrder",c).find(".sort-icon").addClass(e)}},sortEnable:function(){var b=this;this.settings.sortable=!0,this.$element.off("click.cfw.table",this.selectors.headSort).on("click.cfw.table",this.selectors.headSort,function(c){c&&c.preventDefault();var d=a(c.target).closest(b.selectors.headCells).index();b._sortSimple(d)}).off("keydown.cfw.table",this.selectors.headSort).on("keydown.cfw.table",this.selectors.headSort,function(c){if(13==c.which){c.stopPropagation(),c.preventDefault();var d=a(c.target).closest(b.selectors.headCells).index();return void b._sortSimple(d)}b._actionMove(c)}).addClass("sortable"),this._sortUpdate()},sortDisable:function(){this.settings.sortable=!1,this.$element.off("click.cfw.table",this.selectors.headSort).off("keydown.cfw.table",this.selectors.headSort).removeClass("sortable"),this.$sorter=null,this.$element.find(this.selectors.headSort).remove(),this._sortUpdate()},colEditEnable:function(){this.settings.coledit=!0,this.$element.find(this.selectors.headCols).attr("tabindex",0),this.$element.off("click.cfw.table",this.selectors.headCols).on("click.cfw.table",this.selectors.headCols,a.proxy(this._showEditor,this)).off("keydown.cfw.table",this.selectors.headCols).on("keydown.cfw.table",this.selectors.headCols,a.proxy(this._actionKeydown,this))},colEditDisable:function(){this.settings.coledit=!1,this.$element.off("click.cfw.table",this.selectors.headCols).off("keydown.cfw.table",this.selectors.headCols);var a=this.$element.find(this.selectors.headCols);this.settings.sortable?a.attr("tabindex",-1):a.removeAttr("tabindex")},_buildTable:function(){var b=this.$element,c=b.find("tbody");c.length||(c=a(document.createElement("tbody")).appendTo(b));var d=b.find("thead");d.length||(d=a(document.createElement("thead")).insertBefore(c))},_buildColumns:function(b){for(var c=this.$element.find("thead"),d=a(document.createElement("tr")),e=b.header.length,f=0;f<e;f++)d.append(a("<th/>").text(a.trim(b.header[f])));c.append(d)},_buildRows:function(b){for(var c=this.$element.find("tbody"),d=b.rows.length,e=0;e<d;e++){for(var f=b.rows[e],g=a(document.createElement("tr")),h=f.length,i=0;i<h;i++){var j=f[i];null==j&&(j="");var k=a(document.createElement("td")).text(j);g.append(k),this._updateCell(k)}c.append(g)}},jsonInput:function(a){this._buildTable(),this._buildColumns(a),this._buildRows(a)},dispose:function(){this._editorRemove(),this.editDisable(),this.sortDisable(),this.colEditDisable(),this.$element.removeClass("figuration-table").off(".cfw.table").removeData("cfw.table"),this.element=null,this.$element=null,this.$active=null,this.$editor=null,this.$sorter=null,this.instance=null,this.selectors=null,this.settings=null}},a.fn.CFW_Table=b,a.fn.CFW_Table.Constructor=c,a(window).ready(function(){"undefined"!=typeof CFW_API&&CFW_API===!1||a('[data-cfw="table"]').CFW_Table()})}(jQuery);